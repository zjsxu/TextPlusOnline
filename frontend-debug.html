<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frontend Analytics Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        .info { color: blue; }
        button { margin: 5px; padding: 8px 15px; }
        #log { background: #f5f5f5; padding: 10px; height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .status-item { margin: 5px 0; }
    </style>
</head>
<body>
    <h1>ğŸ” Frontend Analytics è¯Šæ–­å·¥å…·</h1>
    
    <div class="debug-section">
        <h3>ğŸ“Š Analytics çŠ¶æ€æ£€æŸ¥</h3>
        <div id="analyticsStatus">æ£€æŸ¥ä¸­...</div>
    </div>
    
    <div class="debug-section">
        <h3>ğŸ”§ é…ç½®æ£€æŸ¥</h3>
        <div id="configStatus">æ£€æŸ¥ä¸­...</div>
        <button onclick="configureBackend()">é…ç½®åå°æœåŠ¡</button>
        <button onclick="checkConfig()">é‡æ–°æ£€æŸ¥é…ç½®</button>
    </div>
    
    <div class="debug-section">
        <h3>ğŸ§ª å‘é€æµ‹è¯•äº‹ä»¶</h3>
        <button onclick="testPageView()">æµ‹è¯•é¡µé¢è®¿é—®</button>
        <button onclick="testFeatureUsage()">æµ‹è¯•åŠŸèƒ½ä½¿ç”¨</button>
        <button onclick="testBatchSend()">æµ‹è¯•æ‰¹é‡å‘é€</button>
        <button onclick="testDirectAPI()">ç›´æ¥APIæµ‹è¯•</button>
    </div>
    
    <div class="debug-section">
        <h3>ğŸ“ˆ åå°æ•°æ®æ£€æŸ¥</h3>
        <button onclick="checkBackendData()">æ£€æŸ¥åå°æ•°æ®</button>
        <button onclick="checkBackendHealth()">æ£€æŸ¥åå°å¥åº·</button>
        <div id="backendStatus">ç‚¹å‡»æŒ‰é’®æ£€æŸ¥åå°çŠ¶æ€</div>
    </div>
    
    <div class="debug-section">
        <h3>ğŸ“ è°ƒè¯•æ—¥å¿—</h3>
        <div id="log"></div>
        <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
    </div>

    <!-- åŒ…å«analyticsè„šæœ¬ -->
    <script src="js/analytics.js"></script>
    
    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function checkAnalyticsStatus() {
            const statusDiv = document.getElementById('analyticsStatus');
            let html = '';
            
            if (window.textDiffAnalytics) {
                html += '<div class="status-item success">âœ… Analytics å¯¹è±¡å·²åˆå§‹åŒ–</div>';
                html += `<div class="status-item info">ğŸ“‹ Session ID: ${window.textDiffAnalytics.sessionId}</div>`;
                html += `<div class="status-item info">â° å¯åŠ¨æ—¶é—´: ${new Date(window.textDiffAnalytics.startTime).toLocaleString()}</div>`;
                html += `<div class="status-item info">ğŸ“Š æœ¬åœ°äº‹ä»¶æ•°: ${window.textDiffAnalytics.events.length}</div>`;
                
                log('Analytics å¯¹è±¡æ£€æŸ¥å®Œæˆ', 'success');
            } else {
                html += '<div class="status-item error">âŒ Analytics å¯¹è±¡æœªåˆå§‹åŒ–</div>';
                log('Analytics å¯¹è±¡æœªæ‰¾åˆ°ï¼', 'error');
            }
            
            statusDiv.innerHTML = html;
        }
        
        function checkConfig() {
            const statusDiv = document.getElementById('configStatus');
            let html = '';
            
            if (window.textDiffAnalytics) {
                const backendUrl = window.textDiffAnalytics.getBackendUrl();
                
                if (backendUrl) {
                    html += `<div class="status-item success">âœ… åå°URLå·²é…ç½®: ${backendUrl}</div>`;
                    log(`åå°URLé…ç½®æ­£ç¡®: ${backendUrl}`, 'success');
                } else {
                    html += '<div class="status-item warning">âš ï¸ åå°URLæœªé…ç½®</div>';
                    log('åå°URLæœªé…ç½®', 'warning');
                }
                
                // æ£€æŸ¥å…¨å±€é…ç½®
                if (window.ANALYTICS_CONFIG) {
                    html += '<div class="status-item info">ğŸ“‹ å…¨å±€é…ç½®å­˜åœ¨</div>';
                    html += `<div class="status-item info">ğŸ”— é…ç½®URL: ${window.ANALYTICS_CONFIG.backendUrl}</div>`;
                    html += `<div class="status-item info">â±ï¸ æ‰¹é‡é—´éš”: ${window.ANALYTICS_CONFIG.batchInterval}ms</div>`;
                    log('å…¨å±€é…ç½®æ£€æŸ¥å®Œæˆ', 'info');
                } else {
                    html += '<div class="status-item warning">âš ï¸ å…¨å±€é…ç½®ä¸å­˜åœ¨</div>';
                    log('å…¨å±€é…ç½®ä¸å­˜åœ¨', 'warning');
                }
            } else {
                html += '<div class="status-item error">âŒ Analytics å¯¹è±¡ä¸å¯ç”¨</div>';
                log('æ— æ³•æ£€æŸ¥é…ç½®ï¼šAnalyticså¯¹è±¡ä¸å­˜åœ¨', 'error');
            }
            
            statusDiv.innerHTML = html;
        }
        
        function configureBackend() {
            if (!window.textDiffAnalytics) {
                log('é…ç½®å¤±è´¥ï¼šAnalyticså¯¹è±¡ä¸å­˜åœ¨', 'error');
                return;
            }
            
            window.textDiffAnalytics.configureBackend({
                backendUrl: 'http://localhost:3001/api/analytics',
                batchInterval: 10000, // 10ç§’ç”¨äºæµ‹è¯•
                enabled: true
            });
            
            log('åå°æœåŠ¡å·²é…ç½®', 'success');
            checkConfig();
        }
        
        async function testPageView() {
            if (!window.textDiffAnalytics) {
                log('æµ‹è¯•å¤±è´¥ï¼šAnalyticså¯¹è±¡ä¸å­˜åœ¨', 'error');
                return;
            }
            
            try {
                window.textDiffAnalytics.trackPageView();
                log('é¡µé¢è®¿é—®äº‹ä»¶å·²å‘é€', 'success');
            } catch (error) {
                log(`é¡µé¢è®¿é—®äº‹ä»¶å‘é€å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function testFeatureUsage() {
            if (!window.textDiffAnalytics) {
                log('æµ‹è¯•å¤±è´¥ï¼šAnalyticså¯¹è±¡ä¸å­˜åœ¨', 'error');
                return;
            }
            
            try {
                window.textDiffAnalytics.trackFeatureUsage('debug_feature', {
                    action: 'manual_test',
                    testTime: new Date().toISOString()
                });
                log('åŠŸèƒ½ä½¿ç”¨äº‹ä»¶å·²å‘é€', 'success');
            } catch (error) {
                log(`åŠŸèƒ½ä½¿ç”¨äº‹ä»¶å‘é€å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function testBatchSend() {
            if (!window.textDiffAnalytics) {
                log('æµ‹è¯•å¤±è´¥ï¼šAnalyticså¯¹è±¡ä¸å­˜åœ¨', 'error');
                return;
            }
            
            try {
                await window.textDiffAnalytics.sendBatchToBackend();
                log('æ‰¹é‡å‘é€å®Œæˆ', 'success');
            } catch (error) {
                log(`æ‰¹é‡å‘é€å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function testDirectAPI() {
            try {
                const response = await fetch('http://localhost:3001/api/analytics/events/feature-usage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: 'direct_test_' + Date.now(),
                        feature: 'direct_api_test',
                        action: 'test',
                        parameters: { source: 'frontend_debug' },
                        duration: 100,
                        timestamp: new Date().toISOString()
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log(`ç›´æ¥APIæµ‹è¯•æˆåŠŸ: ${JSON.stringify(result)}`, 'success');
                } else {
                    log(`ç›´æ¥APIæµ‹è¯•å¤±è´¥: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                log(`ç›´æ¥APIæµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
            }
        }
        
        async function checkBackendHealth() {
            try {
                const response = await fetch('http://localhost:3001/health');
                const data = await response.json();
                
                if (response.ok) {
                    log(`åå°å¥åº·æ£€æŸ¥æˆåŠŸ: ${data.status}`, 'success');
                    document.getElementById('backendStatus').innerHTML = `
                        <div class="success">âœ… åå°æœåŠ¡æ­£å¸¸</div>
                        <div>çŠ¶æ€: ${data.status}</div>
                        <div>è¿è¡Œæ—¶é—´: ${Math.floor(data.uptime / 60)} åˆ†é’Ÿ</div>
                        <div>ç‰ˆæœ¬: ${data.version}</div>
                    `;
                } else {
                    log(`åå°å¥åº·æ£€æŸ¥å¤±è´¥: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`åå°è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                document.getElementById('backendStatus').innerHTML = `
                    <div class="error">âŒ æ— æ³•è¿æ¥åå°æœåŠ¡</div>
                    <div>é”™è¯¯: ${error.message}</div>
                `;
            }
        }
        
        async function checkBackendData() {
            try {
                const response = await fetch('http://localhost:3001/api/analytics/real-time');
                const data = await response.json();
                
                if (response.ok && data.data) {
                    const stats = data.data;
                    log(`åå°æ•°æ®æ£€æŸ¥æˆåŠŸ`, 'success');
                    document.getElementById('backendStatus').innerHTML = `
                        <div class="success">âœ… åå°æ•°æ®æ­£å¸¸</div>
                        <div>åœ¨çº¿ç”¨æˆ·: ${stats.onlineUsers}</div>
                        <div>å½“å‰ä¼šè¯: ${stats.currentSessions}</div>
                        <div>æœ€è¿‘äº‹ä»¶: ${stats.recentEvents?.length || 0}</div>
                        <div>åŠŸèƒ½ä½¿ç”¨: ${JSON.stringify(stats.featureUsage || {})}</div>
                        <div>æ›´æ–°æ—¶é—´: ${new Date(stats.timestamp).toLocaleString()}</div>
                    `;
                } else {
                    log(`åå°æ•°æ®æ£€æŸ¥å¤±è´¥: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`åå°æ•°æ®æ£€æŸ¥å¼‚å¸¸: ${error.message}`, 'error');
            }
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('load', () => {
            log('å‰ç«¯è¯Šæ–­å·¥å…·å¯åŠ¨', 'info');
            
            setTimeout(() => {
                checkAnalyticsStatus();
                checkConfig();
                checkBackendHealth();
            }, 1000);
        });
        
        // ç›‘å¬analyticsäº‹ä»¶
        if (window.textDiffAnalytics) {
            // é‡å†™console.logæ¥æ•è·analyticsçš„æ—¥å¿—
            const originalLog = console.log;
            console.log = function(...args) {
                if (args[0] && args[0].includes('ğŸ“Š')) {
                    log(args.join(' '), 'info');
                }
                originalLog.apply(console, args);
            };
        }
    </script>
</body>
</html>