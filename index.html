<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TextDiff+: æ–‡æœ¬å¯¹æ¯”åˆ†æå·¥å…· | Text Comparison Toolkit</title>
    <link rel="stylesheet" href="style.css">
    <meta name="description" content="ä¸“ä¸šçš„æ–‡æœ¬å¯¹æ¯”åˆ†æå·¥å…·ï¼Œæ”¯æŒPDFã€TXTã€DOCXæ–‡ä»¶ï¼Œæä¾›è¯­ä¹‰åˆ†æã€è¯é¢‘ç»Ÿè®¡ç­‰åŠŸèƒ½">
    <meta name="keywords" content="æ–‡æœ¬å¯¹æ¯”,è¯­ä¹‰åˆ†æ,è¯é¢‘ç»Ÿè®¡,PDFå¯¹æ¯”,å­¦æœ¯å·¥å…·">
</head>
<body>

    <h1>æ–‡ä»¶ä¸æ–‡æœ¬å·®å¼‚å¯¹æ¯”å·¥å…· | Text Comparison Tool (PDF/TXT/DOCX Supported)</h1>
    
    <div class="input-container">
        <div>
            <h2>æ–‡æœ¬ Aï¼ˆæ—§æ–‡æœ¬ï¼‰ | Text A (Old Version)</h2>
            <label for="fileA">ä¸Šä¼ æ–‡ä»¶ A (PDF/TXT/DOCX) | Upload File A (PDF/TXT/DOCX):</label>
            <input type="file" id="fileA" accept=".pdf, .txt, .docx" onchange="uploadFile('A')">
            <textarea id="textA" placeholder="æˆ–åœ¨æ­¤ç²˜è´´æ—§æ–‡æœ¬ | Or paste Text A here..."></textarea>
        </div>
        
        <div>
            <h2>æ–‡æœ¬ Bï¼ˆæ–°æ–‡æœ¬ï¼‰ | Text B (New Version)</h2>
            <label for="fileB">ä¸Šä¼ æ–‡ä»¶ B (PDF/TXT/DOCX) | Upload File B (PDF/TXT/DOCX):</label>
            <input type="file" id="fileB" accept=".pdf, .txt, .docx" onchange="uploadFile('B')">
            <textarea id="textB" placeholder="æˆ–åœ¨æ­¤ç²˜è´´æ–°æ–‡æœ¬ | Or paste Text B here..."></textarea>
        </div>
    </div>

    <button onclick="compareTexts()">æ‰§è¡Œå¯¹æ¯” | Run Comparison</button>

    <h2>å¯¹æ¯”ç»“æœ | Comparison Result</h2>
    <div id="diffOutput">
        <p>ç‚¹å‡»"æ‰§è¡Œå¯¹æ¯”"æŸ¥çœ‹å·®å¼‚ï¼Œæˆ–ä¸Šä¼ æ–‡ä»¶å¼€å§‹è§£æã€‚ | Click "Run Comparison" to see differences, or upload files to begin extraction.</p>
    </div>
    
    <!-- è¯­ä¹‰åˆ†æé¢æ¿ -->
    <h2>è¯­ä¹‰å±‚çº§åˆ†æï¼ˆTone Indexï¼‰ | Semantic Tone Analysis (Tone Index)</h2>
    <div id="semanticAnalysisPanel" style="
        white-space: pre-wrap;
        background: #fafafa;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 6px;
        margin-top: 15px;
    "></div>

    <!-- å¼•å…¥å¤–éƒ¨åº“ -->
    <script src="https://cdn.jsdelivr.net/gh/google/diff-match-patch@master/javascript/diff_match_patch.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    
    <!-- é¢œè‰²è®¾ç½®é¢æ¿ -->
    <div id="colorSettingsPanel" style="margin-top:40px; padding:20px; border:1px solid #ccc; border-radius:8px;">
        <h2>ğŸ¨ è‡ªå®šä¹‰é¢œè‰²ä¸ä¸»é¢˜è®¾ç½® | Custom Color & Theme Settings</h2>

        <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
        <div style="margin-bottom: 15px;">
            <button onclick="applyTheme('default')">é»˜è®¤ä¸»é¢˜ | Default Theme</button>
            <button onclick="applyTheme('highContrast')">é«˜å¯¹æ¯”ä¸»é¢˜ | High Contrast Theme</button>
            <button onclick="applyTheme('custom')">è‡ªå®šä¹‰é¢œè‰² | Custom Colors</button>
        </div>

        <!-- è‡ªå®šä¹‰é¢œè‰²åŒºåŸŸ -->
        <div id="customColorSection" style="display:none; margin-top:20px;">
            <h3>åŠŸèƒ½è¯é«˜äº®é¢œè‰² | Function Word Highlight Colors</h3>

            <label>å¼ºåˆ¶æ€§æƒ…æ€è¯ | Strong Modals:</label>
            <input type="color" id="colorStrong" onchange="updateCustomColor('--fw-strong-bg', this.value)">
            <br><br>

            <label>å¼±æƒ…æ€è¯ | Weak Modals:</label>
            <input type="color" id="colorWeak" onchange="updateCustomColor('--fw-weak-bg', this.value)">
            <br><br>

            <label>è®¸å¯æ€§æƒ…æ€è¯ | Permission Modals:</label>
            <input type="color" id="colorPermission" onchange="updateCustomColor('--fw-permission-bg', this.value)">
            <br><br>

            <label>æ¨¡ç³Šå‰¯è¯ | Hedging Adverbs:</label>
            <input type="color" id="colorHedging" onchange="updateCustomColor('--fw-hedging-bg', this.value)">
            <br><br>

            <label>åŠ å¼ºå‰¯è¯ | Intensifiers:</label>
            <input type="color" id="colorIntensifier" onchange="updateCustomColor('--fw-intensifier-bg', this.value)">
            <br><br>

            <h3>Diff åŒºåŸŸé¢œè‰² | Diff Area Colors</h3>

            <label>åˆ é™¤æ–‡æœ¬ï¼ˆdelï¼‰ | Deleted Text (del):</label>
            <input type="color" id="colorDel" onchange="updateCustomColor('--diff-del-bg', this.value)">
            <br><br>

            <label>æ–°å¢æ–‡æœ¬ï¼ˆinsï¼‰ | Inserted Text (ins):</label>
            <input type="color" id="colorIns" onchange="updateCustomColor('--diff-ins-bg', this.value)">
            <br><br>

            <button onclick="resetCustomColors()">æ¢å¤é»˜è®¤å€¼ | Reset to Default</button>
        </div>
    </div>

    <!-- å›¾è¡¨ä¾§æ ï¼ˆå³ä¾§æµ®åŠ¨ï¼‰ -->
    <div id="chartSidebar" style="
        position: fixed;
        top: 100px;
        right: 0;
        width: 360px;
        height: calc(100% - 120px);
        overflow-y: auto;
        padding: 15px;
        background: #ffffff;
        border-left: 2px solid #ddd;
        box-shadow: -2px 0 5px rgba(0,0,0,0.05);
        z-index: 999;
    ">
        <h2 style="margin-top:0;">ğŸ“Š å¯è§†åŒ–åˆ†æ | Visualization Panel</h2>

        <div class="chartCard" style="margin-bottom:25px;">
            <h3>åŠŸèƒ½è¯å˜åŒ–ï¼ˆB - Aï¼‰ | Function Word Change (B - A)</h3>
            <canvas id="chartChange"></canvas>
        </div>

        <div class="chartCard" style="margin-bottom:25px;">
            <h3>A vs B åŠŸèƒ½è¯å¯¹æ¯” | A vs B Function Word Comparison</h3>
            <canvas id="chartCompare"></canvas>
        </div>

        <div class="chartCard" style="margin-bottom:25px;">
            <h3>è¯­æ°”é›·è¾¾å›¾ï¼ˆTone Profileï¼‰ | Tone Profile Radar Chart</h3>
            <canvas id="chartRadar"></canvas>
        </div>
    </div>

    <!-- åŠŸèƒ½è¯æ ‡æ³¨ä¸ç®¡ç† -->
    <section id="fwAnnotationPanel" style="margin-top:40px; padding:20px; border:1px solid #ccc; border-radius:8px;">
        <h2>âœï¸ åŠŸèƒ½è¯è¯å…¸æ ‡æ³¨ä¸ç®¡ç† | Function Word Dictionary Annotation & Management</h2>
        <p>åœ¨æ­¤å¯æ·»åŠ æˆ–è°ƒæ•´åŠŸèƒ½è¯ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç”¨äºé«˜äº®ä¸è¯­æ°”åˆ†æã€‚<br>
           You may add or modify function words here. They will be used immediately for highlighting and analysis.</p>

        <div style="margin-top:15px;">
            <label for="fwPhraseInput">åŠŸèƒ½è¯/çŸ­è¯­ | Function Word or Phrase:</label><br>
            <input type="text" id="fwPhraseInput" 
                   placeholder="ä¾‹å¦‚ï¼šå¿…é¡» / åº”å½“ / should / might..."
                   style="width:280px; padding:6px; margin-top:5px;">
        </div>

        <div style="margin-top:15px;">
            <label for="fwCategorySelect">ç±»åˆ« | Category:</label><br>
            <select id="fwCategorySelect" style="padding:6px; margin-top:5px;">
                <option value="AUX_MODAL_STRONG">å¼ºåˆ¶æ€§æƒ…æ€è¯ | Strong Modal (must / å¿…é¡»)</option>
                <option value="AUX_MODAL_WEAK">å¼±æƒ…æ€è¯ | Weak Modal (should / åº”å½“)</option>
                <option value="AUX_MODAL_PERMISSION">è®¸å¯æ€§æƒ…æ€è¯ | Permission Modal (may / å¯ä»¥)</option>
                <option value="ADV_HEDGING">æ¨¡ç³Šå‰¯è¯ | Hedging Adverb (likely / å¯èƒ½)</option>
                <option value="ADV_INTENSIFIER">åŠ å¼ºå‰¯è¯ | Intensifier (very / éå¸¸)</option>
            </select>
        </div>

        <div style="margin-top:20px;">
            <button onclick="addFunctionWord()">æ·»åŠ åˆ°è¯å…¸ | Add to Dictionary</button>
            <button onclick="renderFunctionWordDict()">åˆ·æ–°è¯å…¸æ˜¾ç¤º | Refresh Dictionary View</button>
            <button onclick="exportFunctionWordDict()">å¯¼å‡ºè¯å…¸ | Export Dictionary</button>

            <label style="margin-left:10px;">
                å¯¼å…¥è¯å…¸ | Import Dictionary:
                <input type="file" accept=".json" onchange="importFunctionWordDict(this)">
            </label>
            <label style="margin-left:10px;">
                å¯¼å…¥ doccano JSONL:
                <input type="file" accept=".jsonl" onchange="importDoccanoJSONL(this)">
            </label>
            <button onclick="resetToDefaultDict()">æ¢å¤é»˜è®¤è¯å…¸ | Reset to Default Dictionary</button>
        </div>

        <!-- è‡ªå®šä¹‰æ ‡æ³¨ç±»åˆ« -->
        <h3 style="margin-top:30px;">ğŸ†• æ·»åŠ è‡ªå®šä¹‰æ ‡æ³¨ç±»åˆ« | Add Custom Annotation Category</h3>

        <div style="margin-top:10px;">
            <label>ç±»åˆ«æ˜¾ç¤ºåç§° | Display Name:</label><br>
            <input type="text" id="customLabelName" 
                   placeholder="ä¾‹å¦‚ï¼šå›½å®¶å / Country Name"
                   style="width:260px; padding:6px; margin-top:5px;">
        </div>

        <div style="margin-top:10px;">
            <label>ç±»åˆ«ç¼–ç ï¼ˆç³»ç»Ÿå†…éƒ¨ä½¿ç”¨ï¼‰| Category Code (System Key):</label><br>
            <input type="text" id="customLabelCode" 
                   placeholder="ä¾‹å¦‚ï¼šCUSTOM_COUNTRY"
                   style="width:260px; padding:6px; margin-top:5px;">
        </div>

        <div style="margin-top:10px;">
            <label>é«˜äº®é¢œè‰² | Highlight Color:</label><br>
            <input type="color" id="customLabelColor" 
                   value="#ffe599"
                   style="width:120px; height:32px; margin-top:5px;">
        </div>

        <button onclick="addCustomCategory()" style="margin-top:15px;">
            æ·»åŠ ç±»åˆ« | Add Category
        </button>

        <div id="customCategoryList"
             style="margin-top:15px; border:1px solid #aaa; padding:10px; max-height:180px; overflow-y:auto;">
            <p>å°šæ— è‡ªå®šä¹‰ç±»åˆ«ã€‚| No custom categories yet.</p>
        </div>

        <div id="fwDictView"
             style="margin-top:20px; border:1px solid #aaa; padding:10px; max-height:250px; overflow-y:auto;">
            <p>è¯å…¸æœªåŠ è½½æˆ–ä¸ºç©ºã€‚| Dictionary not loaded or empty.</p>
        </div>
    </section>

    <!-- æµ®åŠ¨æ ‡æ³¨èœå• -->
    <div id="selectionMenu"
         style="position:absolute; display:none; z-index:9999;
                padding:8px; background:white; border:1px solid #ccc;
                border-radius:6px; 
                box-shadow:0 2px 6px rgba(0,0,0,0.2);
                pointer-events:auto;">
        <p style="margin:0 0 6px 0; font-size:14px;">é€‰æ‹©ç±»åˆ« | Pick Category</p>
        <button onclick="applySelectionLabel('AUX_MODAL_STRONG')">å¼ºåˆ¶æ€§ | Strong</button>
        <button onclick="applySelectionLabel('AUX_MODAL_WEAK')">å¼± | Weak</button>
        <button onclick="applySelectionLabel('AUX_MODAL_PERMISSION')">è®¸å¯ | Permission</button>
        <button onclick="applySelectionLabel('ADV_HEDGING')">æ¨¡ç³Š | Hedging</button>
        <button onclick="applySelectionLabel('ADV_INTENSIFIER')">åŠ å¼º | Intensifier</button>
        <button onclick="hideSelectionMenu()">å–æ¶ˆ | Cancel</button>
    </div>

    <!-- è¯é¢‘ç»Ÿè®¡é¢æ¿ -->
    <section id="freqPanel" style="margin-top:40px; padding:20px; border:1px solid #ccc; border-radius:8px;">
        <h2>ğŸ” è¯é¢‘ç»Ÿè®¡ | Word Frequency Analysis</h2>
        <p>æ˜¾ç¤ºæ–‡æœ¬ A ä¸æ–‡æœ¬ B ä¸­å‡ºç°æ¬¡æ•°æœ€é«˜çš„è¯è¯­ï¼ˆä¸­è‹±æ–‡è‡ªåŠ¨åˆ†è¯ï¼‰ã€‚</p>

        <button onclick="runFrequencyAnalysis()">è¿è¡Œè¯é¢‘åˆ†æ | Run Frequency Analysis</button>

        <div style="display:flex; gap:20px; margin-top:20px;">
            <div style="flex:1;">
                <h3>æ–‡æœ¬ A é«˜é¢‘è¯ | Top Words in Text A</h3>
                <div id="freqTableA" 
                     style="margin-top:10px; border:1px solid #aaa; padding:10px; min-height:200px;">
                </div>
            </div>

            <div style="flex:1;">
                <h3>æ–‡æœ¬ B é«˜é¢‘è¯ | Top Words in Text B</h3>
                <div id="freqTableB" 
                     style="margin-top:10px; border:1px solid #aaa; padding:10px; min-height:200px;">
                </div>
            </div>
        </div>

        <h3 style="margin-top:20px;">è¯é¢‘å·®å¼‚å›¾ | Frequency Difference Chart</h3>
        <canvas id="freqChart" style="max-width:500px;"></canvas>
    </section>

    <!-- ç½‘ç«™ä½¿ç”¨ç»Ÿè®¡é¢æ¿ -->
    <section id="analyticsPanel" style="margin-top:40px; padding:20px; border:1px solid #ccc; border-radius:8px;">
        <h2>ğŸ“Š ç½‘ç«™ä½¿ç”¨ç»Ÿè®¡ | Website Usage Analytics</h2>
        <p>æŸ¥çœ‹æœ¬åœ°ä½¿ç”¨ç»Ÿè®¡æ•°æ®ï¼ˆæ•°æ®ä»…å­˜å‚¨åœ¨æ‚¨çš„æµè§ˆå™¨ä¸­ï¼Œä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼‰ã€‚</p>
        
        <!-- å®æ—¶ç”¨æˆ·ç»Ÿè®¡æ˜¾ç¤º -->
        <div style="background: #f0f8ff; padding: 15px; border-radius: 5px; margin: 15px 0; text-align: center;">
            <h4 style="margin: 0 0 10px 0; color: #333;">ğŸŒ å®æ—¶ç»Ÿè®¡ | Real-time Stats</h4>
            <div style="display: flex; justify-content: space-around; flex-wrap: wrap;">
                <div style="margin: 5px;">
                    <strong style="font-size: 1.5em; color: #007bff;" class="user-count">0</strong>
                    <div style="font-size: 0.9em; color: #666;">å½“å‰åœ¨çº¿ | Online Now</div>
                </div>
                <div style="margin: 5px;">
                    <strong style="font-size: 1.5em; color: #28a745;" class="visit-count">0</strong>
                    <div style="font-size: 0.9em; color: #666;">æ€»è®¿é—®é‡ | Total Visits</div>
                </div>
            </div>
        </div>

        <div style="margin-top:15px;">
            <button onclick="showAnalyticsSummary()">æ˜¾ç¤ºç»Ÿè®¡æ‘˜è¦ | Show Analytics Summary</button>
            <button onclick="exportAnalyticsData()">å¯¼å‡ºç»Ÿè®¡æ•°æ® | Export Analytics Data</button>
            <button onclick="clearAnalyticsData()">æ¸…é™¤ç»Ÿè®¡æ•°æ® | Clear Analytics Data</button>
        </div>
        
        <!-- ç®¡ç†å‘˜å·¥å…· (ä»…å¼€å‘ç¯å¢ƒæ˜¾ç¤º) -->
        <div id="adminTools" style="margin-top:10px; display:none;">
            <p style="color:#666; font-size:0.9em;">ğŸ”§ ç³»ç»Ÿç®¡ç†å‘˜å·¥å…· (å¼€å‘ç¯å¢ƒ)</p>
            <button onclick="openAdminDashboard()" style="background:#6f42c1; color:white;">ğŸ“Š ç®¡ç†é¢æ¿ | Admin Dashboard</button>
            <button onclick="configureAnalyticsSystem()" style="background:#007bff; color:white;">âš™ï¸ ç³»ç»Ÿé…ç½® | System Config</button>
            <button onclick="testBackendConnection()" style="background:#28a745; color:white;">ğŸ”— æµ‹è¯•è¿æ¥ | Test Connection</button>
        </div>

        <div id="analyticsSummary" style="margin-top:20px; padding:15px; background:#f9f9f9; border-radius:6px; display:none;">
            <h3>ç»Ÿè®¡æ‘˜è¦ | Analytics Summary</h3>
            <div id="analyticsContent"></div>
        </div>
    </section>

    <!-- åº”ç”¨è„šæœ¬ -->
    <script src="analytics-config.js"></script>
    <script src="user-counter.js"></script>
    <script src="js/analytics.js"></script>
    <script src="js/theme.js"></script>
    <script src="js/diff_core.js"></script>
    <script src="js/tone_analysis.js"></script>
    <script src="js/dict_manager.js"></script>
    <script src="js/annotator.js"></script>
    <script src="js/frequency.js"></script>
    <script src="js/main.js"></script>
</body>
</html>