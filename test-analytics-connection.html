<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Connection Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { margin: 5px; padding: 10px 15px; }
        #log { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 20px; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>ğŸ”§ Analytics Connection Test</h1>
    
    <div class="test-result info">
        <strong>æµ‹è¯•ç›®çš„:</strong> è¯Šæ–­å‰ç«¯analyticsæ•°æ®ä¸ºä»€ä¹ˆæ²¡æœ‰åˆ°è¾¾åå°
    </div>

    <h2>ğŸ§ª æµ‹è¯•æ­¥éª¤</h2>
    <button onclick="testBackendHealth()">1. æµ‹è¯•åå°å¥åº·çŠ¶æ€</button>
    <button onclick="testAnalyticsInit()">2. æµ‹è¯•Analyticsåˆå§‹åŒ–</button>
    <button onclick="testDirectSend()">3. æµ‹è¯•ç›´æ¥å‘é€æ•°æ®</button>
    <button onclick="testPageView()">4. æµ‹è¯•é¡µé¢è®¿é—®è¿½è¸ª</button>
    <button onclick="testFeatureUsage()">5. æµ‹è¯•åŠŸèƒ½ä½¿ç”¨è¿½è¸ª</button>
    <button onclick="testBatchSend()">6. æµ‹è¯•æ‰¹é‡å‘é€</button>
    <button onclick="checkBackendData()">7. æ£€æŸ¥åå°æ•°æ®</button>
    <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>

    <div id="log"></div>

    <script src="js/analytics.js"></script>
    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const typeIcon = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸';
            logDiv.textContent += `[${timestamp}] ${typeIcon} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        async function testBackendHealth() {
            log('æµ‹è¯•åå°å¥åº·çŠ¶æ€...');
            try {
                const response = await fetch('http://localhost:3001/health');
                const data = await response.json();
                log(`åå°å¥åº·çŠ¶æ€: ${data.status}, è¿è¡Œæ—¶é—´: ${Math.floor(data.uptime/60)}åˆ†é’Ÿ`, 'success');
            } catch (error) {
                log(`åå°è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testAnalyticsInit() {
            log('æµ‹è¯•Analyticsåˆå§‹åŒ–...');
            if (window.textDiffAnalytics) {
                log('Analyticså¯¹è±¡å·²åˆå§‹åŒ–', 'success');
                log(`ä¼šè¯ID: ${window.textDiffAnalytics.sessionId}`);
                
                const backendUrl = window.textDiffAnalytics.getBackendUrl();
                log(`åå°URL: ${backendUrl || 'null (æœ¬åœ°å­˜å‚¨æ¨¡å¼)'}`);
                
                if (backendUrl) {
                    log('æ£€æµ‹åˆ°å¼€å‘ç¯å¢ƒï¼Œå°†å‘é€æ•°æ®åˆ°åå°', 'success');
                } else {
                    log('æ£€æµ‹åˆ°ç”Ÿäº§ç¯å¢ƒæˆ–å…¶ä»–ç¯å¢ƒï¼Œä»…ä½¿ç”¨æœ¬åœ°å­˜å‚¨', 'info');
                }
            } else {
                log('Analyticså¯¹è±¡æœªåˆå§‹åŒ–', 'error');
            }
        }

        async function testDirectSend() {
            log('æµ‹è¯•ç›´æ¥å‘é€æ•°æ®åˆ°åå°...');
            try {
                const testData = {
                    sessionId: 'test_session_' + Date.now(),
                    url: window.location.href,
                    userAgent: navigator.userAgent,
                    timestamp: new Date().toISOString()
                };

                const response = await fetch('http://localhost:3001/api/analytics/events/page-view', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });

                const result = await response.json();
                log(`ç›´æ¥å‘é€æˆåŠŸ: ${result.message}`, 'success');
            } catch (error) {
                log(`ç›´æ¥å‘é€å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testPageView() {
            log('æµ‹è¯•é¡µé¢è®¿é—®è¿½è¸ª...');
            if (window.textDiffAnalytics) {
                try {
                    window.textDiffAnalytics.trackPageView();
                    log('é¡µé¢è®¿é—®è¿½è¸ªè°ƒç”¨æˆåŠŸ', 'success');
                } catch (error) {
                    log(`é¡µé¢è®¿é—®è¿½è¸ªå¤±è´¥: ${error.message}`, 'error');
                }
            } else {
                log('Analyticså¯¹è±¡ä¸å­˜åœ¨', 'error');
            }
        }

        async function testFeatureUsage() {
            log('æµ‹è¯•åŠŸèƒ½ä½¿ç”¨è¿½è¸ª...');
            if (window.textDiffAnalytics) {
                try {
                    window.textDiffAnalytics.trackFeatureUsage('test_feature', { action: 'test' });
                    log('åŠŸèƒ½ä½¿ç”¨è¿½è¸ªè°ƒç”¨æˆåŠŸ', 'success');
                } catch (error) {
                    log(`åŠŸèƒ½ä½¿ç”¨è¿½è¸ªå¤±è´¥: ${error.message}`, 'error');
                }
            } else {
                log('Analyticså¯¹è±¡ä¸å­˜åœ¨', 'error');
            }
        }

        async function testBatchSend() {
            log('æµ‹è¯•æ‰¹é‡å‘é€...');
            if (window.textDiffAnalytics) {
                try {
                    await window.textDiffAnalytics.sendBatchToBackend();
                    log('æ‰¹é‡å‘é€è°ƒç”¨æˆåŠŸ', 'success');
                } catch (error) {
                    log(`æ‰¹é‡å‘é€å¤±è´¥: ${error.message}`, 'error');
                }
            } else {
                log('Analyticså¯¹è±¡ä¸å­˜åœ¨', 'error');
            }
        }

        async function checkBackendData() {
            log('æ£€æŸ¥åå°æ•°æ®...');
            try {
                const response = await fetch('http://localhost:3001/api/analytics/real-time');
                const data = await response.json();
                
                log(`åœ¨çº¿ç”¨æˆ·: ${data.data.onlineUsers}`);
                log(`æ´»è·ƒä¼šè¯: ${data.data.currentSessions}`);
                log(`æœ€è¿‘äº‹ä»¶æ•°: ${data.data.recentEvents.length}`);
                log(`åŠŸèƒ½ä½¿ç”¨: ${JSON.stringify(data.data.featureUsage)}`);
                
                if (data.data.recentEvents.length > 0) {
                    log('æœ€è¿‘3ä¸ªäº‹ä»¶:');
                    data.data.recentEvents.slice(-3).forEach((event, i) => {
                        log(`  ${i+1}. ${event.type || event.event} - ${event.feature || 'N/A'} - ${event.timestamp}`);
                    });
                }
            } catch (error) {
                log(`æ£€æŸ¥åå°æ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡ŒåŸºæœ¬æµ‹è¯•
        window.addEventListener('load', () => {
            log('=== Analytics Connection Test Started ===');
            setTimeout(() => {
                testBackendHealth();
                setTimeout(() => testAnalyticsInit(), 1000);
            }, 500);
        });
    </script>
</body>
</html>