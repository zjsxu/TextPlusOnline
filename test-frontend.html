<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Frontend Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { margin: 5px; padding: 8px 15px; }
        #log { background: #f5f5f5; padding: 10px; height: 200px; overflow-y: auto; font-family: monospace; }
    </style>
</head>
<body>
    <h1>ğŸ§ª TextDiff+ Analytics Frontend Test</h1>
    
    <div class="test-section">
        <h3>ğŸ“Š Analytics Status</h3>
        <p>Session ID: <span id="sessionId">Loading...</span></p>
        <p>Backend Status: <span id="backendStatus">Not configured</span></p>
        <p>Events Sent: <span id="eventCount">0</span></p>
    </div>
    
    <div class="test-section">
        <h3>ğŸ”§ Configuration</h3>
        <button onclick="configureBackend()">Configure Backend</button>
        <button onclick="testConnection()">Test Connection</button>
        <button onclick="sendBatch()">Send Batch Now</button>
    </div>
    
    <div class="test-section">
        <h3>ğŸ¯ Test Events</h3>
        <button onclick="testPageView()">Test Page View</button>
        <button onclick="testFeatureUsage()">Test Feature Usage</button>
        <button onclick="testFileUpload()">Test File Upload</button>
        <button onclick="testTextComparison()">Test Text Comparison</button>
    </div>
    
    <div class="test-section">
        <h3>ğŸ“ˆ Analytics Summary</h3>
        <button onclick="showSummary()">Show Summary</button>
        <button onclick="exportData()">Export Data</button>
        <button onclick="clearData()">Clear Data</button>
    </div>
    
    <div class="test-section">
        <h3>ğŸ“ Log Output</h3>
        <div id="log"></div>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <!-- Include the analytics script -->
    <script src="js/analytics.js"></script>
    
    <script>
        let eventCount = 0;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStatus() {
            if (window.textDiffAnalytics) {
                document.getElementById('sessionId').textContent = window.textDiffAnalytics.sessionId;
                
                const backendUrl = window.textDiffAnalytics.getBackendUrl();
                document.getElementById('backendStatus').textContent = backendUrl ? 
                    `Connected (${backendUrl})` : 'Not configured';
                    
                document.getElementById('eventCount').textContent = eventCount;
            }
        }
        
        function configureBackend() {
            if (!window.textDiffAnalytics) {
                log('Analytics not initialized!', 'error');
                return;
            }
            
            window.textDiffAnalytics.configureBackend({
                backendUrl: 'http://localhost:3001/api/analytics',
                batchInterval: 10000, // 10 seconds for testing
                enabled: true
            });
            
            log('Backend configured: http://localhost:3001/api/analytics', 'success');
            updateStatus();
        }
        
        function testConnection() {
            if (!window.textDiffAnalytics) {
                log('Analytics not initialized!', 'error');
                return;
            }
            
            window.textDiffAnalytics.trackFeatureUsage('backend_test', {
                action: 'connection_test',
                timestamp: new Date().toISOString()
            });
            
            eventCount++;
            log('Test connection event sent', 'success');
            updateStatus();
        }
        
        function sendBatch() {
            if (!window.textDiffAnalytics) {
                log('Analytics not initialized!', 'error');
                return;
            }
            
            window.textDiffAnalytics.sendBatchToBackend()
                .then(() => {
                    log('Batch sent successfully', 'success');
                })
                .catch(error => {
                    log('Batch send failed: ' + error.message, 'error');
                });
        }
        
        function testPageView() {
            if (!window.textDiffAnalytics) {
                log('Analytics not initialized!', 'error');
                return;
            }
            
            // Simulate page view
            window.textDiffAnalytics.trackPageView();
            eventCount++;
            log('Page view event sent', 'success');
            updateStatus();
        }
        
        function testFeatureUsage() {
            if (!window.textDiffAnalytics) {
                log('Analytics not initialized!', 'error');
                return;
            }
            
            window.textDiffAnalytics.trackFeatureUsage('test_feature', {
                action: 'manual_test',
                testData: 'frontend_test'
            });
            
            eventCount++;
            log('Feature usage event sent', 'success');
            updateStatus();
        }
        
        function testFileUpload() {
            if (!window.textDiffAnalytics) {
                log('Analytics not initialized!', 'error');
                return;
            }
            
            window.textDiffAnalytics.trackFileUpload('text/plain', 1024);
            eventCount++;
            log('File upload event sent', 'success');
            updateStatus();
        }
        
        function testTextComparison() {
            if (!window.textDiffAnalytics) {
                log('Analytics not initialized!', 'error');
                return;
            }
            
            window.textDiffAnalytics.trackTextComparison(500, 600, 25);
            eventCount++;
            log('Text comparison event sent', 'success');
            updateStatus();
        }
        
        function showSummary() {
            if (!window.textDiffAnalytics) {
                log('Analytics not initialized!', 'error');
                return;
            }
            
            const summary = window.textDiffAnalytics.getAnalyticsSummary();
            log('Analytics Summary: ' + JSON.stringify(summary, null, 2), 'info');
        }
        
        function exportData() {
            if (!window.textDiffAnalytics) {
                log('Analytics not initialized!', 'error');
                return;
            }
            
            window.textDiffAnalytics.exportAnalytics();
            log('Data exported to downloads', 'success');
        }
        
        function clearData() {
            if (!window.textDiffAnalytics) {
                log('Analytics not initialized!', 'error');
                return;
            }
            
            if (confirm('Clear all local analytics data?')) {
                window.textDiffAnalytics.clearLocalAnalytics();
                eventCount = 0;
                log('Local analytics data cleared', 'success');
                updateStatus();
            }
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // Initialize when page loads
        window.addEventListener('load', () => {
            log('Page loaded, initializing analytics test...', 'info');
            
            // Wait a bit for analytics to initialize
            setTimeout(() => {
                if (window.textDiffAnalytics) {
                    log('Analytics initialized successfully!', 'success');
                    updateStatus();
                } else {
                    log('Analytics failed to initialize!', 'error');
                }
            }, 1000);
        });
        
        // Update status every 5 seconds
        setInterval(updateStatus, 5000);
    </script>
</body>
</html>