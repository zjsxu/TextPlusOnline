<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº‘ç«¯åå°éƒ¨ç½²éªŒè¯ | Cloud Backend Deployment Verification</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f7fa;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: transform 0.2s;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .result {
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border-left: 5px solid #28a745;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border-left: 5px solid #dc3545;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 5px solid #17a2b8;
        }
        .loading {
            background: #fff3cd;
            color: #856404;
            border-left: 5px solid #ffc107;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸš€ äº‘ç«¯åå°éƒ¨ç½²éªŒè¯</h1>
        <p>Cloud Backend Deployment Verification</p>
    </div>

    <div class="test-section">
        <h3>ğŸ” 1. åå°æœåŠ¡å¥åº·æ£€æŸ¥ | Backend Health Check</h3>
        <button class="btn" onclick="testHealth()">æ£€æŸ¥å¥åº·çŠ¶æ€ | Check Health</button>
        <div id="healthResult"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ“Š 2. æ•°æ®å‘é€æµ‹è¯• | Data Sending Test</h3>
        <button class="btn" onclick="testPageView()">æµ‹è¯•é¡µé¢è®¿é—® | Test Page View</button>
        <button class="btn" onclick="testFeatureUsage()">æµ‹è¯•åŠŸèƒ½ä½¿ç”¨ | Test Feature Usage</button>
        <div id="sendResult"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ“ˆ 3. å®æ—¶æ•°æ®æŸ¥è¯¢ | Real-time Data Query</h3>
        <button class="btn" onclick="testRealTimeData()">æŸ¥è¯¢å®æ—¶ç»Ÿè®¡ | Query Real-time Stats</button>
        <div id="queryResult"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ¯ 4. å®Œæ•´æµç¨‹æµ‹è¯• | Complete Flow Test</h3>
        <button class="btn" onclick="testCompleteFlow()">è¿è¡Œå®Œæ•´æµ‹è¯• | Run Complete Test</button>
        <div id="flowResult"></div>
    </div>

    <div class="test-section">
        <h3>âš™ï¸ 5. é…ç½®ä¿¡æ¯ | Configuration Info</h3>
        <div id="configInfo"></div>
    </div>

    <script>
        // é…ç½®
        const BACKEND_URLS = {
            railway: 'https://textdiff-analytics-production.up.railway.app',
            render: 'https://textdiff-analytics.onrender.com',
            local: 'http://localhost:3001'
        };

        let currentBackend = BACKEND_URLS.railway;

        // æ˜¾ç¤ºé…ç½®ä¿¡æ¯
        function showConfigInfo() {
            const info = `
å½“å‰ç¯å¢ƒ: ${window.location.hostname}
å½“å‰åå°: ${currentBackend}
ç”¨æˆ·ä»£ç†: ${navigator.userAgent.substring(0, 80)}...
æ—¶é—´æˆ³: ${new Date().toISOString()}

Available Backends:
- Railway: ${BACKEND_URLS.railway}
- Render: ${BACKEND_URLS.render}
- Local: ${BACKEND_URLS.local}
            `;
            document.getElementById('configInfo').innerHTML = `<div class="info">${info}</div>`;
        }

        // å·¥å…·å‡½æ•°
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${type}">${message}</div>`;
        }

        function showLoading(elementId, message) {
            showResult(elementId, `â³ ${message}`, 'loading');
        }

        // 1. å¥åº·æ£€æŸ¥
        async function testHealth() {
            showLoading('healthResult', 'æ­£åœ¨æ£€æŸ¥åå°æœåŠ¡å¥åº·çŠ¶æ€...');
            
            try {
                const response = await fetch(`${currentBackend}/health`);
                const data = await response.json();
                
                if (response.ok) {
                    const result = `
âœ… åå°æœåŠ¡è¿è¡Œæ­£å¸¸ï¼

æœåŠ¡çŠ¶æ€: ${data.status}
ç‰ˆæœ¬: ${data.version}
è¿è¡Œæ—¶é—´: ${Math.floor(data.uptime / 60)} åˆ†é’Ÿ
ç¯å¢ƒ: ${data.environment}
æ—¶é—´æˆ³: ${new Date(data.timestamp).toLocaleString('zh-CN')}
                    `;
                    showResult('healthResult', result, 'success');
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                const result = `
âŒ åå°æœåŠ¡è¿æ¥å¤±è´¥ï¼

é”™è¯¯ä¿¡æ¯: ${error.message}
åå°åœ°å€: ${currentBackend}
å»ºè®®: è¯·æ£€æŸ¥åå°æœåŠ¡æ˜¯å¦å·²æ­£ç¡®éƒ¨ç½²
                `;
                showResult('healthResult', result, 'error');
            }
        }

        // 2. é¡µé¢è®¿é—®æµ‹è¯•
        async function testPageView() {
            showLoading('sendResult', 'æ­£åœ¨æµ‹è¯•é¡µé¢è®¿é—®æ•°æ®å‘é€...');
            
            try {
                const testData = {
                    sessionId: `test_${Date.now()}`,
                    url: window.location.href,
                    referrer: document.referrer || '',
                    userAgent: navigator.userAgent,
                    screenResolution: `${screen.width}x${screen.height}`,
                    language: navigator.language,
                    timestamp: new Date().toISOString()
                };

                const response = await fetch(`${currentBackend}/api/analytics/events/page-view`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    const message = `
âœ… é¡µé¢è®¿é—®æ•°æ®å‘é€æˆåŠŸï¼

ä¼šè¯ID: ${testData.sessionId}
å“åº”: ${JSON.stringify(result, null, 2)}
                    `;
                    showResult('sendResult', message, 'success');
                } else {
                    throw new Error(`HTTP ${response.status}: ${JSON.stringify(result)}`);
                }
            } catch (error) {
                const message = `
âŒ é¡µé¢è®¿é—®æ•°æ®å‘é€å¤±è´¥ï¼

é”™è¯¯: ${error.message}
                `;
                showResult('sendResult', message, 'error');
            }
        }

        // 3. åŠŸèƒ½ä½¿ç”¨æµ‹è¯•
        async function testFeatureUsage() {
            showLoading('sendResult', 'æ­£åœ¨æµ‹è¯•åŠŸèƒ½ä½¿ç”¨æ•°æ®å‘é€...');
            
            try {
                const testData = {
                    sessionId: `test_${Date.now()}`,
                    feature: 'deployment_test',
                    action: 'verification',
                    parameters: {
                        testType: 'feature_usage',
                        timestamp: new Date().toISOString()
                    },
                    duration: 0,
                    timestamp: new Date().toISOString()
                };

                const response = await fetch(`${currentBackend}/api/analytics/events/feature-usage`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    const message = `
âœ… åŠŸèƒ½ä½¿ç”¨æ•°æ®å‘é€æˆåŠŸï¼

åŠŸèƒ½: ${testData.feature}
åŠ¨ä½œ: ${testData.action}
å“åº”: ${JSON.stringify(result, null, 2)}
                    `;
                    showResult('sendResult', message, 'success');
                } else {
                    throw new Error(`HTTP ${response.status}: ${JSON.stringify(result)}`);
                }
            } catch (error) {
                const message = `
âŒ åŠŸèƒ½ä½¿ç”¨æ•°æ®å‘é€å¤±è´¥ï¼

é”™è¯¯: ${error.message}
                `;
                showResult('sendResult', message, 'error');
            }
        }

        // 4. å®æ—¶æ•°æ®æŸ¥è¯¢
        async function testRealTimeData() {
            showLoading('queryResult', 'æ­£åœ¨æŸ¥è¯¢å®æ—¶ç»Ÿè®¡æ•°æ®...');
            
            try {
                const response = await fetch(`${currentBackend}/api/analytics/real-time`);
                const data = await response.json();
                
                if (response.ok) {
                    const stats = data.data || data;
                    const message = `
âœ… å®æ—¶æ•°æ®æŸ¥è¯¢æˆåŠŸï¼

åœ¨çº¿ç”¨æˆ·: ${stats.onlineUsers || 0}
å½“å‰ä¼šè¯: ${stats.currentSessions || 0}
æ¯åˆ†é’Ÿäº‹ä»¶: ${stats.eventsPerMinute?.current || 0}
æ€»äº‹ä»¶æ•°: ${stats.totalEvents || 0}
ç³»ç»Ÿå¥åº·: ${stats.systemHealth?.status || 'unknown'} (${stats.systemHealth?.score || 0}/100)

æœ€è¿‘äº‹ä»¶æ•°é‡: ${stats.recentEvents?.length || 0}
åŠŸèƒ½ä½¿ç”¨ç»Ÿè®¡: ${Object.keys(stats.featureUsage || {}).length} ç§åŠŸèƒ½
åœ°ç†åˆ†å¸ƒ: ${Object.keys(stats.geographicDistribution || {}).length} ä¸ªåœ°åŒº
                    `;
                    showResult('queryResult', message, 'success');
                } else {
                    throw new Error(`HTTP ${response.status}: ${JSON.stringify(data)}`);
                }
            } catch (error) {
                const message = `
âŒ å®æ—¶æ•°æ®æŸ¥è¯¢å¤±è´¥ï¼

é”™è¯¯: ${error.message}
                `;
                showResult('queryResult', message, 'error');
            }
        }

        // 5. å®Œæ•´æµç¨‹æµ‹è¯•
        async function testCompleteFlow() {
            showLoading('flowResult', 'æ­£åœ¨è¿è¡Œå®Œæ•´æµç¨‹æµ‹è¯•...');
            
            const results = [];
            
            try {
                // æ­¥éª¤1: å¥åº·æ£€æŸ¥
                results.push('ğŸ” æ­¥éª¤1: å¥åº·æ£€æŸ¥...');
                const healthResponse = await fetch(`${currentBackend}/health`);
                if (!healthResponse.ok) throw new Error('å¥åº·æ£€æŸ¥å¤±è´¥');
                results.push('âœ… å¥åº·æ£€æŸ¥é€šè¿‡');

                // æ­¥éª¤2: å‘é€é¡µé¢è®¿é—®
                results.push('ğŸ“Š æ­¥éª¤2: å‘é€é¡µé¢è®¿é—®æ•°æ®...');
                const sessionId = `flow_test_${Date.now()}`;
                const pageViewResponse = await fetch(`${currentBackend}/api/analytics/events/page-view`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        url: window.location.href,
                        userAgent: navigator.userAgent,
                        language: navigator.language,
                        timestamp: new Date().toISOString()
                    })
                });
                if (!pageViewResponse.ok) throw new Error('é¡µé¢è®¿é—®æ•°æ®å‘é€å¤±è´¥');
                results.push('âœ… é¡µé¢è®¿é—®æ•°æ®å‘é€æˆåŠŸ');

                // æ­¥éª¤3: å‘é€åŠŸèƒ½ä½¿ç”¨
                results.push('ğŸ¯ æ­¥éª¤3: å‘é€åŠŸèƒ½ä½¿ç”¨æ•°æ®...');
                const featureResponse = await fetch(`${currentBackend}/api/analytics/events/feature-usage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        feature: 'complete_flow_test',
                        action: 'verification',
                        parameters: { testType: 'complete_flow' },
                        timestamp: new Date().toISOString()
                    })
                });
                if (!featureResponse.ok) throw new Error('åŠŸèƒ½ä½¿ç”¨æ•°æ®å‘é€å¤±è´¥');
                results.push('âœ… åŠŸèƒ½ä½¿ç”¨æ•°æ®å‘é€æˆåŠŸ');

                // æ­¥éª¤4: æŸ¥è¯¢å®æ—¶æ•°æ®
                results.push('ğŸ“ˆ æ­¥éª¤4: æŸ¥è¯¢å®æ—¶ç»Ÿè®¡...');
                await new Promise(resolve => setTimeout(resolve, 1000)); // ç­‰å¾…1ç§’è®©æ•°æ®å¤„ç†
                const statsResponse = await fetch(`${currentBackend}/api/analytics/real-time`);
                if (!statsResponse.ok) throw new Error('å®æ—¶æ•°æ®æŸ¥è¯¢å¤±è´¥');
                const statsData = await statsResponse.json();
                results.push('âœ… å®æ—¶æ•°æ®æŸ¥è¯¢æˆåŠŸ');

                // å®Œæˆ
                results.push('');
                results.push('ğŸ‰ å®Œæ•´æµç¨‹æµ‹è¯•æˆåŠŸï¼');
                results.push(`ä¼šè¯ID: ${sessionId}`);
                results.push(`æ€»äº‹ä»¶æ•°: ${(statsData.data || statsData).totalEvents || 0}`);
                results.push('');
                results.push('âœ… åå°ç›‘æ§ç³»ç»Ÿå·²æ­£å¸¸å·¥ä½œï¼');
                results.push('âœ… GitHub Pagesç”¨æˆ·æ•°æ®å°†è¢«æ­£ç¡®æ”¶é›†ï¼');

                showResult('flowResult', results.join('\n'), 'success');

            } catch (error) {
                results.push('');
                results.push(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`);
                results.push('');
                results.push('è¯·æ£€æŸ¥:');
                results.push('1. åå°æœåŠ¡æ˜¯å¦æ­£ç¡®éƒ¨ç½²');
                results.push('2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸');
                results.push('3. CORSé…ç½®æ˜¯å¦æ­£ç¡®');
                
                showResult('flowResult', results.join('\n'), 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºé…ç½®ä¿¡æ¯
        window.addEventListener('load', () => {
            showConfigInfo();
        });
    </script>
</body>
</html>