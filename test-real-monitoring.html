<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çœŸå®ç›‘æ§ç³»ç»Ÿæµ‹è¯• | Real Monitoring System Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f7fa;
        }
        .header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .test-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        .btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: transform 0.2s;
            width: 100%;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }
        .result {
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            max-height: 200px;
            overflow-y: auto;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border-left: 5px solid #28a745;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border-left: 5px solid #dc3545;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 5px solid #17a2b8;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-item {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%);
            border-radius: 10px;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #28a745;
        }
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¯ çœŸå®ç›‘æ§ç³»ç»Ÿæµ‹è¯•</h1>
        <p>Real Monitoring System Test</p>
        <p>éªŒè¯GitHub Pagesç”¨æˆ·æ•°æ®æ˜¯å¦è¢«æ­£ç¡®æ”¶é›†åˆ°äº‘ç«¯åå°</p>
    </div>

    <div class="test-grid">
        <!-- ç³»ç»ŸçŠ¶æ€ -->
        <div class="test-card">
            <h3>ğŸ“Š ç³»ç»ŸçŠ¶æ€ | System Status</h3>
            <div class="stats" id="systemStats">
                <div class="stat-item">
                    <div class="stat-value" id="backendStatus">-</div>
                    <div class="stat-label">åå°çŠ¶æ€</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="analyticsStatus">-</div>
                    <div class="stat-label">åˆ†æç³»ç»Ÿ</div>
                </div>
            </div>
            <button class="btn" onclick="checkSystemStatus()">æ£€æŸ¥ç³»ç»ŸçŠ¶æ€</button>
            <div id="statusResult"></div>
        </div>

        <!-- æ•°æ®å‘é€æµ‹è¯• -->
        <div class="test-card">
            <h3>ğŸ“¤ æ•°æ®å‘é€æµ‹è¯• | Data Sending Test</h3>
            <button class="btn" onclick="simulatePageView()">æ¨¡æ‹Ÿé¡µé¢è®¿é—®</button>
            <button class="btn" onclick="simulateFeatureUsage()">æ¨¡æ‹ŸåŠŸèƒ½ä½¿ç”¨</button>
            <button class="btn" onclick="simulateUserActivity()">æ¨¡æ‹Ÿç”¨æˆ·æ´»åŠ¨</button>
            <div id="sendingResult"></div>
        </div>

        <!-- å®æ—¶ç›‘æ§ -->
        <div class="test-card">
            <h3>ğŸ“ˆ å®æ—¶ç›‘æ§ | Real-time Monitoring</h3>
            <div class="stats" id="realTimeStats">
                <div class="stat-item">
                    <div class="stat-value" id="onlineUsers">-</div>
                    <div class="stat-label">åœ¨çº¿ç”¨æˆ·</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalEvents">-</div>
                    <div class="stat-label">æ€»äº‹ä»¶æ•°</div>
                </div>
            </div>
            <button class="btn" onclick="refreshRealTimeData()">åˆ·æ–°å®æ—¶æ•°æ®</button>
            <button class="btn btn-secondary" onclick="toggleAutoRefresh()">è‡ªåŠ¨åˆ·æ–°</button>
            <div id="monitoringResult"></div>
        </div>

        <!-- å®Œæ•´æµ‹è¯• -->
        <div class="test-card">
            <h3>ğŸ§ª å®Œæ•´æµ‹è¯• | Complete Test</h3>
            <p>è¿è¡Œå®Œæ•´çš„ç«¯åˆ°ç«¯æµ‹è¯•ï¼ŒéªŒè¯æ•´ä¸ªæ•°æ®æµç¨‹</p>
            <button class="btn" onclick="runCompleteTest()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
            <div id="completeResult"></div>
        </div>
    </div>

    <!-- æµ‹è¯•æ—¥å¿— -->
    <div class="test-card">
        <h3>ğŸ“ æµ‹è¯•æ—¥å¿— | Test Log</h3>
        <button class="btn btn-secondary" onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        <div id="testLog" style="font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px;"></div>
    </div>

    <script>
        // é…ç½®
        const BACKEND_URL = 'https://textdiff-analytics-production.up.railway.app';
        let autoRefreshInterval = null;
        let testSessionId = `test_${Date.now()}`;

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('zh-CN');
            const logElement = document.getElementById('testLog');
            const typeIcon = {
                'info': 'â„¹ï¸',
                'success': 'âœ…',
                'error': 'âŒ',
                'warning': 'âš ï¸'
            }[type] || 'â„¹ï¸';
            
            logElement.innerHTML += `[${timestamp}] ${typeIcon} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
        }

        function showResult(elementId, message, type = 'info') {
            document.getElementById(elementId).innerHTML = `<div class="${type}">${message}</div>`;
        }

        // 1. æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        async function checkSystemStatus() {
            log('å¼€å§‹æ£€æŸ¥ç³»ç»ŸçŠ¶æ€...');
            
            try {
                // æ£€æŸ¥åå°æœåŠ¡
                const healthResponse = await fetch(`${BACKEND_URL}/health`);
                const healthData = await healthResponse.json();
                
                if (healthResponse.ok) {
                    document.getElementById('backendStatus').textContent = 'âœ…';
                    log(`åå°æœåŠ¡æ­£å¸¸: ${healthData.status}`, 'success');
                } else {
                    document.getElementById('backendStatus').textContent = 'âŒ';
                    log('åå°æœåŠ¡å¼‚å¸¸', 'error');
                }

                // æ£€æŸ¥åˆ†æç³»ç»Ÿ
                if (window.textDiffAnalytics) {
                    document.getElementById('analyticsStatus').textContent = 'âœ…';
                    log('åˆ†æç³»ç»Ÿå·²åŠ è½½', 'success');
                } else {
                    document.getElementById('analyticsStatus').textContent = 'âŒ';
                    log('åˆ†æç³»ç»ŸæœªåŠ è½½', 'error');
                }

                showResult('statusResult', 'ç³»ç»ŸçŠ¶æ€æ£€æŸ¥å®Œæˆ', 'success');

            } catch (error) {
                document.getElementById('backendStatus').textContent = 'âŒ';
                log(`ç³»ç»ŸçŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                showResult('statusResult', `æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // 2. æ¨¡æ‹Ÿé¡µé¢è®¿é—®
        async function simulatePageView() {
            log('æ¨¡æ‹Ÿé¡µé¢è®¿é—®...');
            
            try {
                const data = {
                    sessionId: testSessionId,
                    url: window.location.href,
                    referrer: document.referrer || '',
                    userAgent: navigator.userAgent,
                    screenResolution: `${screen.width}x${screen.height}`,
                    language: navigator.language,
                    timestamp: new Date().toISOString()
                };

                const response = await fetch(`${BACKEND_URL}/api/analytics/events/page-view`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (response.ok) {
                    log(`é¡µé¢è®¿é—®æ•°æ®å‘é€æˆåŠŸ: ${testSessionId}`, 'success');
                    showResult('sendingResult', 'é¡µé¢è®¿é—®æ•°æ®å‘é€æˆåŠŸ', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}: ${JSON.stringify(result)}`);
                }

            } catch (error) {
                log(`é¡µé¢è®¿é—®æ•°æ®å‘é€å¤±è´¥: ${error.message}`, 'error');
                showResult('sendingResult', `å‘é€å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // 3. æ¨¡æ‹ŸåŠŸèƒ½ä½¿ç”¨
        async function simulateFeatureUsage() {
            log('æ¨¡æ‹ŸåŠŸèƒ½ä½¿ç”¨...');
            
            try {
                const features = ['text_comparison', 'file_upload', 'dictionary_usage', 'theme_change'];
                const feature = features[Math.floor(Math.random() * features.length)];
                
                const data = {
                    sessionId: testSessionId,
                    feature: feature,
                    action: 'test_simulation',
                    parameters: {
                        testType: 'simulation',
                        randomValue: Math.random()
                    },
                    duration: Math.floor(Math.random() * 1000),
                    timestamp: new Date().toISOString()
                };

                const response = await fetch(`${BACKEND_URL}/api/analytics/events/feature-usage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (response.ok) {
                    log(`åŠŸèƒ½ä½¿ç”¨æ•°æ®å‘é€æˆåŠŸ: ${feature}`, 'success');
                    showResult('sendingResult', `åŠŸèƒ½ä½¿ç”¨æ•°æ®å‘é€æˆåŠŸ: ${feature}`, 'success');
                } else {
                    throw new Error(`HTTP ${response.status}: ${JSON.stringify(result)}`);
                }

            } catch (error) {
                log(`åŠŸèƒ½ä½¿ç”¨æ•°æ®å‘é€å¤±è´¥: ${error.message}`, 'error');
                showResult('sendingResult', `å‘é€å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // 4. æ¨¡æ‹Ÿç”¨æˆ·æ´»åŠ¨
        async function simulateUserActivity() {
            log('æ¨¡æ‹Ÿç”¨æˆ·æ´»åŠ¨...');
            
            const activities = [
                { feature: 'user_activity', action: 'page_visible' },
                { feature: 'user_activity', action: 'resumed_activity' },
                { feature: 'frequency_analysis', action: 'analyze' },
                { feature: 'dictionary_usage', action: 'add_word' }
            ];

            try {
                for (const activity of activities) {
                    const data = {
                        sessionId: testSessionId,
                        feature: activity.feature,
                        action: activity.action,
                        parameters: { simulation: true },
                        timestamp: new Date().toISOString()
                    };

                    await fetch(`${BACKEND_URL}/api/analytics/events/feature-usage`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    await new Promise(resolve => setTimeout(resolve, 200)); // é—´éš”200ms
                }

                log(`ç”¨æˆ·æ´»åŠ¨æ¨¡æ‹Ÿå®Œæˆ: ${activities.length} ä¸ªæ´»åŠ¨`, 'success');
                showResult('sendingResult', `ç”¨æˆ·æ´»åŠ¨æ¨¡æ‹Ÿå®Œæˆ: ${activities.length} ä¸ªæ´»åŠ¨`, 'success');

            } catch (error) {
                log(`ç”¨æˆ·æ´»åŠ¨æ¨¡æ‹Ÿå¤±è´¥: ${error.message}`, 'error');
                showResult('sendingResult', `æ¨¡æ‹Ÿå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // 5. åˆ·æ–°å®æ—¶æ•°æ®
        async function refreshRealTimeData() {
            log('åˆ·æ–°å®æ—¶æ•°æ®...');
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/analytics/real-time`);
                const data = await response.json();
                
                if (response.ok) {
                    const stats = data.data || data;
                    
                    document.getElementById('onlineUsers').textContent = stats.onlineUsers || 0;
                    document.getElementById('totalEvents').textContent = stats.totalEvents || 0;
                    
                    log(`å®æ—¶æ•°æ®æ›´æ–°: åœ¨çº¿ç”¨æˆ· ${stats.onlineUsers || 0}, æ€»äº‹ä»¶ ${stats.totalEvents || 0}`, 'success');
                    showResult('monitoringResult', 'å®æ—¶æ•°æ®åˆ·æ–°æˆåŠŸ', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }

            } catch (error) {
                log(`å®æ—¶æ•°æ®åˆ·æ–°å¤±è´¥: ${error.message}`, 'error');
                showResult('monitoringResult', `åˆ·æ–°å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // 6. åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°
        function toggleAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                log('è‡ªåŠ¨åˆ·æ–°å·²åœæ­¢', 'info');
            } else {
                autoRefreshInterval = setInterval(refreshRealTimeData, 10000); // 10ç§’åˆ·æ–°
                log('è‡ªåŠ¨åˆ·æ–°å·²å¯åŠ¨ (10ç§’é—´éš”)', 'info');
            }
        }

        // 7. è¿è¡Œå®Œæ•´æµ‹è¯•
        async function runCompleteTest() {
            log('å¼€å§‹è¿è¡Œå®Œæ•´æµ‹è¯•...', 'info');
            showResult('completeResult', 'æ­£åœ¨è¿è¡Œå®Œæ•´æµ‹è¯•...', 'info');
            
            const results = [];
            
            try {
                // æµ‹è¯•1: ç³»ç»ŸçŠ¶æ€
                log('æµ‹è¯•1: æ£€æŸ¥ç³»ç»ŸçŠ¶æ€');
                await checkSystemStatus();
                results.push('âœ… ç³»ç»ŸçŠ¶æ€æ£€æŸ¥');

                // æµ‹è¯•2: é¡µé¢è®¿é—®
                log('æµ‹è¯•2: é¡µé¢è®¿é—®æ•°æ®');
                await simulatePageView();
                results.push('âœ… é¡µé¢è®¿é—®æ•°æ®å‘é€');

                // æµ‹è¯•3: åŠŸèƒ½ä½¿ç”¨
                log('æµ‹è¯•3: åŠŸèƒ½ä½¿ç”¨æ•°æ®');
                await simulateFeatureUsage();
                results.push('âœ… åŠŸèƒ½ä½¿ç”¨æ•°æ®å‘é€');

                // æµ‹è¯•4: ç”¨æˆ·æ´»åŠ¨
                log('æµ‹è¯•4: ç”¨æˆ·æ´»åŠ¨æ•°æ®');
                await simulateUserActivity();
                results.push('âœ… ç”¨æˆ·æ´»åŠ¨æ•°æ®å‘é€');

                // ç­‰å¾…æ•°æ®å¤„ç†
                log('ç­‰å¾…æ•°æ®å¤„ç†...');
                await new Promise(resolve => setTimeout(resolve, 2000));

                // æµ‹è¯•5: å®æ—¶æ•°æ®æŸ¥è¯¢
                log('æµ‹è¯•5: å®æ—¶æ•°æ®æŸ¥è¯¢');
                await refreshRealTimeData();
                results.push('âœ… å®æ—¶æ•°æ®æŸ¥è¯¢');

                // å®Œæˆ
                log('å®Œæ•´æµ‹è¯•æˆåŠŸå®Œæˆ!', 'success');
                showResult('completeResult', `å®Œæ•´æµ‹è¯•æˆåŠŸ!\n\n${results.join('\n')}`, 'success');

            } catch (error) {
                log(`å®Œæ•´æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                showResult('completeResult', `æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', () => {
            log('çœŸå®ç›‘æ§ç³»ç»Ÿæµ‹è¯•é¡µé¢å·²åŠ è½½');
            log(`æµ‹è¯•ä¼šè¯ID: ${testSessionId}`);
            log(`åå°æœåŠ¡åœ°å€: ${BACKEND_URL}`);
            
            // è‡ªåŠ¨æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
            setTimeout(checkSystemStatus, 1000);
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        });
    </script>
</body>
</html>